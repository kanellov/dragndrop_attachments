!function(e,t,a){if("undefined"!=typeof t.rcmail){var n=t.rcmail;n.addEventListener("init",function(){e(a).ready(function(){function o(){return t.XMLHttpRequest?req=new XMLHttpRequest:n.display_message(n.get_label("fileuploaderror"),"error"),req}function r(e){var t="--",n="\r\n",o="";return o+=t,o+=e,o+=n,o+='Content-Disposition: form-data; name="_token"',o+=n,o+=n,o+=a.getElementsByName("_token")[0].value,o+=n}function l(e,t,a){var n="--",o="\r\n",r="";return r+=n,r+=a,r+=o,r+='Content-Disposition: form-data; name="_attachments[]"',r+='; filename="'+unescape(encodeURIComponent(e))+'"',r+=o,r+="Content-Type: application/octet-stream",r+=o,r+=o,r+=t,r+=o}function c(e){var t="--",a="\r\n",n="";return n+=t,n+=e,n+=t,n+=a}function i(t){function i(e){m+=l(e.target.name,e.target.result,f),p--,0===p&&d(m,f)}function d(e,t){var l,i,d;l=t,i=r(l),i+=e,i+=c(l),d=o(),d.open("POST",b,!0),d.setRequestHeader("content-type","multipart/form-data; boundary="+l),d.sendAsBinary=function(e){function t(e){return 255&e.charCodeAt(0)}var a,n;a=Array.prototype.map.call(e,t),n=new Uint8Array(a),this.send(n.buffer)},d.sendAsBinary(i),d.onreadystatechange=function(){var e,t,o,r,l,c;4==d.readyState&&(e="",e=d.responseText,e.match(/add2attachment/)||e.match(/display_message/)||n.display_message(n.get_label("fileuploaderror"),"error"),t=e.search("rcmfile"),o=t+31,r=e.substring(t,o),l=a.createElement("iframe"),l.name=r,l.style.border="none",l.style.width=0,l.style.height=0,l.style.visibility="hidden",a.body.appendChild(l),c=l.document,l.contentDocument?c=l.contentDocument:l.contentWindow&&(c=l.contentWindow.document),c.open(),c.writeln(e),c.close(),n.display_message(n.gettext("all_files_successfully_uploaded","dragndrop_attachments"),"confirmation"))}}var s,u,f,m,p,g,_,y,h,v,b,w,D;if(t.stopPropagation(),t.preventDefault(),e("#compose-attachments").css("background-color","#fff"),data=t.dataTransfer,data.files.length>4)return alert(n.gettext("too_many_files_to_upload","dragndrop_attachments")),!1;for(s=0,u=0;u<data.files.length;u++)s+=data.files[u].size;if(s>1e7)return alert(n.gettext("files_to_upload_bigger_than_allowed","dragndrop_attachments")),!1;for(f="----WebKitFormBoundary"+(new Date).getTime(),m="",p=data.files.length,_=(new Date).getTime(),y="rcmupload"+_,h=_,v=data.files,b=n.url("upload",{_id:n.env.compose_id||"",_uploadid:_}),w="<span>"+n.get_label("uploading"+(v.length>1?"many":""))+"</span>",_=y.replace(/^rcmupload/,""),n.env.loadingicon&&(w='<img src="'+n.env.loadingicon+'" alt="" class="uploading" />'+w),w='<a title="'+n.get_label("cancel")+'" onclick="return rcmail.cancel_attachment_upload(\''+_+"', '"+y+'\');" href="#cancelupload" class="cancelupload">'+(n.env.cancelicon?'<img src="'+n.env.cancelicon+'" alt="" />':n.get_label("cancel"))+"</a>"+w,n.add2attachment_list(_,{name:"",html:w,classname:"uploading",complete:!1}),D=0;D<data.files.length;D++)g=new FileReader,g.data=data,g.file=data.files[D],g.name=data.files[D].name,g.readAsBinaryString(data.files[D]),g.onload=i;t.stopPropagation()}var d=a.getElementById("compose-attachments");d.ondragenter=d.ondragover=function(t){return t.preventDefault(),e("#compose-attachments").css("background-color","#FFFFA6"),t.dataTransfer.dropEffect="copy",!1},d.ondragleave=function(t){return t.preventDefault(),e("#compose-attachments").css("background-color","#fff"),t.dataTransfer.dropEffect="copy",!1},d.ondrop=i})})}}(jQuery,window,document);